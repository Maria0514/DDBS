{% extends "base.html" %}

{% block title %}系统监控 - 分布式数据库系统{% endblock %}

{% block page_title %}系统监控{% endblock %}

{% block content %}
<!-- 系统概览 -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-white bg-primary">
            <div class="card-body text-center">
                <h3 id="system-uptime">00:00:00</h3>
                <p>系统运行时间</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-success">
            <div class="card-body text-center">
                <h3 id="total-requests">0</h3>
                <p>总请求数</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-info">
            <div class="card-body text-center">
                <h3 id="avg-response-time">0ms</h3>
                <p>平均响应时间</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-warning">
            <div class="card-body text-center">
                <h3 id="error-rate">0%</h3>
                <p>错误率</p>
            </div>
        </div>
    </div>
</div>

<!-- 数据库节点状态 -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-database"></i>
                    数据库节点状态
                </h5>
            </div>
            <div class="card-body">
                <div id="database-nodes">
                    <!-- 动态加载数据库节点信息 -->
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-network-wired"></i>
                    网络连接状态
                </h5>
            </div>
            <div class="card-body">
                <canvas id="network-chart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- 性能监控图表 -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-line"></i>
                    事务处理性能
                </h5>
            </div>
            <div class="card-body">
                <canvas id="performance-chart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-tachometer-alt"></i>
                    系统负载
                </h5>
            </div>
            <div class="card-body">
                <canvas id="load-chart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- 实时日志监控 -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-terminal"></i>
                    实时系统日志
                </h5>
                <div>
                    <select class="form-select form-select-sm d-inline-block w-auto me-2" id="log-level-filter">
                        <option value="all">所有级别</option>
                        <option value="error">错误</option>
                        <option value="warning">警告</option>
                        <option value="info">信息</option>
                        <option value="debug">调试</option>
                    </select>
                    <button class="btn btn-sm btn-outline-light" onclick="clearSystemLogs()">
                        <i class="fas fa-trash"></i> 清空
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="system-logs" class="bg-dark text-light p-3 rounded" style="height: 300px; overflow-y: auto; font-family: monospace;">
                    <div class="text-muted">等待日志数据...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 系统配置和控制 -->
<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-cog"></i>
                    系统配置
                </h5>
            </div>
            <div class="card-body">
                <form id="system-config-form">
                    <div class="mb-3">
                        <label class="form-label">事务超时时间 (秒)</label>
                        <input type="number" class="form-control" id="transaction-timeout" value="60">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">最大重试次数</label>
                        <input type="number" class="form-control" id="max-retries" value="3">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">连接池大小</label>
                        <input type="number" class="form-control" id="pool-size" value="5">
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="debug-mode">
                            <label class="form-check-label" for="debug-mode">
                                调试模式
                            </label>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> 保存配置
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-tools"></i>
                    系统控制
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-success" onclick="testConnections()">
                        <i class="fas fa-plug"></i> 测试数据库连接
                    </button>
                    <button class="btn btn-info" onclick="refreshStats()">
                        <i class="fas fa-sync-alt"></i> 刷新统计数据
                    </button>
                    <button class="btn btn-warning" onclick="clearCache()">
                        <i class="fas fa-broom"></i> 清空缓存
                    </button>
                    <button class="btn btn-secondary" onclick="exportSystemReport()">
                        <i class="fas fa-file-export"></i> 导出系统报告
                    </button>
                    <!-- 新增测试按钮 -->
                    <button class="btn btn-primary" id="test-button">
                        <i class="fas fa-flask"></i> 测试
                    </button>
                </div>
                
                <hr>
                
                <div class="alert alert-warning" role="alert">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>危险操作</strong>
                </div>
                
                <div class="d-grid gap-2">
                    <button class="btn btn-danger" onclick="restartSystem()">
                        <i class="fas fa-redo"></i> 重启系统
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let demoInterval;
    let currentStep = 0;
    let transactionChart;
    
    // 初始化图表
    function initChart() {
        const ctx = document.getElementById('transaction-chart').getContext('2d');
        transactionChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['已提交', '已回滚', '活跃中'],
                datasets: [{
                    data: [0, 0, 0],
                    backgroundColor: ['#28a745', '#dc3545', '#ffc107']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }
    
    // 2PC演示动画
    function startDemo() {
        const steps = [
            { phase: "初始化事务", coordinator: "bg-primary", p1: "bg-secondary", p2: "bg-secondary" },
            { phase: "阶段1：发送准备请求", coordinator: "bg-warning", p1: "bg-warning", p2: "bg-warning" },
            { phase: "阶段1：参与者准备", coordinator: "bg-warning", p1: "bg-info", p2: "bg-info" },
            { phase: "阶段1：收集投票结果", coordinator: "bg-info", p1: "bg-info", p2: "bg-info" },
            { phase: "阶段2：发送提交请求", coordinator: "bg-success", p1: "bg-warning", p2: "bg-warning" },
            { phase: "阶段2：执行提交", coordinator: "bg-success", p1: "bg-success", p2: "bg-success" },
            { phase: "事务完成", coordinator: "bg-primary", p1: "bg-secondary", p2: "bg-secondary" }
        ];
        
        currentStep = 0;
        
        demoInterval = setInterval(() => {
            if (currentStep < steps.length) {
                const step = steps[currentStep];
                
                // 更新阶段指示器
                document.getElementById('phase-indicator').textContent = step.phase;
                
                // 更新状态指示器
                document.getElementById('coordinator-status').className = `badge ${step.coordinator} p-3 mb-2`;
                document.getElementById('participant1-status').className = `badge ${step.p1} p-3 mb-2`;
                document.getElementById('participant2-status').className = `badge ${step.p2} p-3 mb-2`;
                
                // 高亮当前步骤
                document.querySelectorAll('.step-item').forEach((item, index) => {
                    if (index === currentStep) {
                        item.className = 'step-item mb-2 p-2 border-start border-3 border-primary bg-light';
                    } else {
                        item.className = 'step-item mb-2 p-2 border-start border-3 border-secondary';
                    }
                });
                
                currentStep++;
            } else {
                clearInterval(demoInterval);
                document.getElementById('demo-start').disabled = false;
                document.getElementById('demo-pause').disabled = true;
                currentStep = 0;
            }
        }, 2000);
        
        document.getElementById('demo-start').disabled = true;
        document.getElementById('demo-pause').disabled = false;
    }
    
    // 暂停演示
    function pauseDemo() {
        clearInterval(demoInterval);
        document.getElementById('demo-start').disabled = false;
        document.getElementById('demo-pause').disabled = true;
    }
    
    // 重置演示
    function resetDemo() {
        clearInterval(demoInterval);
        currentStep = 0;
        
        document.getElementById('phase-indicator').textContent = '等待事务开始...';
        document.getElementById('coordinator-status').className = 'badge bg-primary p-3 mb-2';
        document.getElementById('participant1-status').className = 'badge bg-secondary p-3 mb-2';
        document.getElementById('participant2-status').className = 'badge bg-secondary p-3 mb-2';
        
        document.querySelectorAll('.step-item').forEach(item => {
            item.className = 'step-item mb-2 p-2 border-start border-3 border-secondary';
        });
        
        document.getElementById('demo-start').disabled = false;
        document.getElementById('demo-pause').disabled = true;
    }
    
    // 添加事务日志条目
    function addTransactionLog(transactionId, type, status, participants, details) {
        const table = document.getElementById('transaction-log-table');
        
        if (table.children.length === 1 && table.children[0].children.length === 1) {
            table.innerHTML = '';
        }
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${new Date().toLocaleString()}</td>
            <td><code>${transactionId}</code></td>
            <td><span class="badge bg-info">${type}</span></td>
            <td><span class="badge bg-${status === 'COMMITTED' ? 'success' : status === 'ABORTED' ? 'danger' : 'warning'}">${status}</span></td>
            <td>${participants}</td>
            <td>${details}</td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="viewTransactionDetails('${transactionId}')">
                    <i class="fas fa-eye"></i>
                </button>
            </td>
        `;
        
        table.insertBefore(row, table.firstChild);
        
        // 限制日志条目数量
        while (table.children.length > 100) {
            table.removeChild(table.lastChild);
        }
    }
    
    // 清空事务日志
    function clearTransactionLogs() {
        document.getElementById('transaction-log-table').innerHTML = 
            '<tr><td colspan="7" class="text-center">暂无事务记录</td></tr>';
    }
    
    // 导出日志
    function exportLogs() {
        // 这里可以实现日志导出功能
        showMessage('日志导出功能开发中...', 'info');
    }
    
    // 查看事务详情
    function viewTransactionDetails(transactionId) {
        showMessage(`查看事务 ${transactionId} 的详细信息`, 'info');
    }
    
    // 更新统计数据
    function updateStats() {
        // 模拟统计数据
        const committed = Math.floor(Math.random() * 50) + 20;
        const aborted = Math.floor(Math.random() * 10) + 2;
        const active = Math.floor(Math.random() * 5);
        const total = committed + aborted + active;
        
        document.getElementById('total-transactions').textContent = total;
        document.getElementById('committed-transactions').textContent = committed;
        document.getElementById('aborted-transactions').textContent = aborted;
        document.getElementById('active-transactions').textContent = active;
        
        // 更新图表
        if (transactionChart) {
            transactionChart.data.datasets[0].data = [committed, aborted, active];
            transactionChart.update();
        }
    }
    
    // 事务测试表单
    document.getElementById('transaction-test-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const scenario = document.getElementById('test-scenario').value;
        const fromAccount = document.getElementById('test-from-account').value;
        const toAccount = document.getElementById('test-to-account').value;
        const amount = document.getElementById('test-amount').value;
        
        // 生成模拟事务ID
        const transactionId = 'tx_' + Date.now();
        
        // 根据场景模拟不同结果
        let status, details;
        switch (scenario) {
            case 'normal':
                status = 'COMMITTED';
                details = `正常转账: ${fromAccount} → ${toAccount}, ¥${amount}`;
                break;
            case 'insufficient':
                status = 'ABORTED';
                details = `余额不足: 账户 ${fromAccount}`;
                break;
            case 'network-failure':
                status = 'ABORTED';
                details = `网络故障: 无法连接到参与者`;
                break;
            case 'participant-failure':
                status = 'ABORTED';
                details = `参与者故障: 数据库2响应超时`;
                break;
        }
        
        // 添加到日志
        addTransactionLog(transactionId, 'TRANSFER', status, 'DB1, DB2', details);
        
        // 显示结果消息
        const messageType = status === 'COMMITTED' ? 'success' : 'error';
        showMessage(`测试完成: ${details}`, messageType);
        
        // 更新统计
        updateStats();
    });
    
    // Socket.IO事件监听
    socket.on('transfer_completed', function(data) {
        const transactionId = 'tx_' + Date.now();
        addTransactionLog(
            transactionId, 
            'TRANSFER', 
            'COMMITTED', 
            'DB1, DB2', 
            `转账: ${data.from_account} → ${data.to_account}, ¥${data.amount}`
        );
        updateStats();
    });
    
    socket.on('order_processed', function(data) {
        const transactionId = 'tx_' + Date.now();
        addTransactionLog(
            transactionId, 
            'ORDER', 
            'COMMITTED', 
            'DB1, DB2', 
            `订单: 产品 ${data.product_id}, 数量 ${data.quantity}`
        );
        updateStats();
    });
    
    // 页面加载时初始化
    document.addEventListener('DOMContentLoaded', function() {
        initChart();
        updateStats();
        
        // 定期更新统计数据
        setInterval(updateStats, 10000);
    });

    // 新增测试按钮点击事件
    document.getElementById('test-button').addEventListener('click', function() {
        fetch('/api/test', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showMessage(data.message, 'success');
            } else {
                showMessage(data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error running test:', error);
            showMessage('测试失败', 'error');
        });
    });
</script>
{% endblock %}