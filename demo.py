#!/usr/bin/env python3
"""
åˆ†å¸ƒå¼æ•°æ®åº“ç³»ç»Ÿæ¼”ç¤ºè„šæœ¬
å±•ç¤ºç³»ç»Ÿçš„æ ¸å¿ƒåŠŸèƒ½å’Œ2PCåè®®çš„å·¥ä½œåŸç†
"""
import time
import random
from typing import List, Dict
import sys
import os

# æ·»åŠ é¡¹ç›®æ ¹ç›®å½•åˆ°Pythonè·¯å¾„
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

def print_banner():
    """æ‰“å°ç³»ç»Ÿæ¨ªå¹…"""
    banner = """
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘                    åˆ†å¸ƒå¼æ•°æ®åº“ç³»ç»Ÿæ¼”ç¤º                        â•‘
    â•‘                åŸºäº2PCï¼ˆäºŒé˜¶æ®µæäº¤ï¼‰åè®®                       â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    """
    print(banner)

def print_section(title: str):
    """æ‰“å°ç« èŠ‚æ ‡é¢˜"""
    print(f"\n{'='*60}")
    print(f"  {title}")
    print(f"{'='*60}")

def simulate_2pc_protocol():
    """æ¨¡æ‹Ÿ2PCåè®®æ‰§è¡Œè¿‡ç¨‹"""
    print_section("2PCåè®®æ¼”ç¤º")
    
    participants = ["æ•°æ®åº“1 (MySQL:3306)", "æ•°æ®åº“2 (MySQL:3307)"]
    transaction_id = f"tx_{int(time.time())}"
    
    print(f"ğŸš€ å¼€å§‹åˆ†å¸ƒå¼äº‹åŠ¡: {transaction_id}")
    print(f"ğŸ“‹ å‚ä¸è€…: {', '.join(participants)}")
    
    # é˜¶æ®µ1ï¼šå‡†å¤‡é˜¶æ®µ
    print(f"\nğŸ“ é˜¶æ®µ1ï¼šå‡†å¤‡é˜¶æ®µ")
    print("   åè°ƒå™¨ -> æ‰€æœ‰å‚ä¸è€…: å‡†å¤‡æäº¤è¯·æ±‚")
    
    for i, participant in enumerate(participants, 1):
        time.sleep(0.5)
        print(f"   {participant}: å‡†å¤‡ä¸­...")
        time.sleep(0.5)
        print(f"   {participant}: âœ… å‡†å¤‡å®Œæˆï¼Œå¯ä»¥æäº¤")
    
    print("   åè°ƒå™¨: æ”¶åˆ°æ‰€æœ‰å‚ä¸è€…çš„å‡†å¤‡ç¡®è®¤")
    
    # é˜¶æ®µ2ï¼šæäº¤é˜¶æ®µ
    print(f"\nğŸ“ é˜¶æ®µ2ï¼šæäº¤é˜¶æ®µ")
    print("   åè°ƒå™¨ -> æ‰€æœ‰å‚ä¸è€…: æäº¤è¯·æ±‚")
    
    for i, participant in enumerate(participants, 1):
        time.sleep(0.5)
        print(f"   {participant}: æ‰§è¡Œæäº¤...")
        time.sleep(0.5)
        print(f"   {participant}: âœ… æäº¤å®Œæˆ")
    
    print(f"   åè°ƒå™¨: äº‹åŠ¡ {transaction_id} æäº¤æˆåŠŸ")
    print(f"\nğŸ‰ åˆ†å¸ƒå¼äº‹åŠ¡å®Œæˆï¼")

def simulate_banking_scenario():
    """æ¨¡æ‹Ÿé“¶è¡Œè½¬è´¦åœºæ™¯"""
    print_section("é“¶è¡Œè½¬è´¦åœºæ™¯æ¼”ç¤º")
    
    # æ¨¡æ‹Ÿè´¦æˆ·æ•°æ®
    accounts = {
        1001: {"balance": 5000.00, "name": "å¼ ä¸‰"},
        1002: {"balance": 3000.00, "name": "æå››"},
        1003: {"balance": 1000.00, "name": "ç‹äº”"}
    }
    
    print("ğŸ’° å½“å‰è´¦æˆ·çŠ¶æ€:")
    for acc_id, info in accounts.items():
        print(f"   è´¦æˆ· {acc_id} ({info['name']}): Â¥{info['balance']:.2f}")
    
    # æ¨¡æ‹Ÿè½¬è´¦æ“ä½œ
    from_account = 1001
    to_account = 1002
    amount = 500.00
    
    print(f"\nğŸ”„ æ‰§è¡Œè½¬è´¦: {from_account} -> {to_account}, é‡‘é¢: Â¥{amount}")
    
    # æ£€æŸ¥ä½™é¢
    print(f"   æ£€æŸ¥è´¦æˆ· {from_account} ä½™é¢...")
    if accounts[from_account]["balance"] >= amount:
        print(f"   âœ… ä½™é¢å……è¶³: Â¥{accounts[from_account]['balance']}")
    else:
        print(f"   âŒ ä½™é¢ä¸è¶³: Â¥{accounts[from_account]['balance']}")
        return
    
    # æ¨¡æ‹Ÿ2PCè¿‡ç¨‹
    print(f"\n   å¼€å§‹2PCäº‹åŠ¡...")
    time.sleep(1)
    
    print(f"   é˜¶æ®µ1: å‡†å¤‡æ›´æ–°è´¦æˆ·ä½™é¢...")
    time.sleep(1)
    print(f"   é˜¶æ®µ1: æ‰€æœ‰å‚ä¸è€…å‡†å¤‡å®Œæˆ")
    
    print(f"   é˜¶æ®µ2: æ‰§è¡Œä½™é¢æ›´æ–°...")
    accounts[from_account]["balance"] -= amount
    accounts[to_account]["balance"] += amount
    time.sleep(1)
    print(f"   é˜¶æ®µ2: ä½™é¢æ›´æ–°å®Œæˆ")
    
    print(f"\nğŸ’° è½¬è´¦åè´¦æˆ·çŠ¶æ€:")
    for acc_id, info in accounts.items():
        print(f"   è´¦æˆ· {acc_id} ({info['name']}): Â¥{info['balance']:.2f}")
    
    print(f"\nâœ… è½¬è´¦æˆåŠŸå®Œæˆï¼")

def simulate_inventory_scenario():
    """æ¨¡æ‹Ÿåº“å­˜ç®¡ç†åœºæ™¯"""
    print_section("åº“å­˜ç®¡ç†åœºæ™¯æ¼”ç¤º")
    
    # æ¨¡æ‹Ÿåº“å­˜æ•°æ®
    inventory = {
        101: {"name": "ç¬”è®°æœ¬ç”µè„‘", "quantity": 50, "price": 999.99},
        102: {"name": "æ— çº¿é¼ æ ‡", "quantity": 200, "price": 29.99},
        103: {"name": "æœºæ¢°é”®ç›˜", "quantity": 150, "price": 79.99}
    }
    
    print("ğŸ“¦ å½“å‰åº“å­˜çŠ¶æ€:")
    for prod_id, info in inventory.items():
        print(f"   äº§å“ {prod_id} ({info['name']}): {info['quantity']} ä»¶, Â¥{info['price']}")
    
    # æ¨¡æ‹Ÿè®¢å•å¤„ç†
    product_id = 101
    order_quantity = 2
    customer_id = 2001
    
    print(f"\nğŸ›’ å¤„ç†è®¢å•: äº§å“ {product_id}, æ•°é‡ {order_quantity}, å®¢æˆ· {customer_id}")
    
    # æ£€æŸ¥åº“å­˜
    print(f"   æ£€æŸ¥äº§å“ {product_id} åº“å­˜...")
    if inventory[product_id]["quantity"] >= order_quantity:
        print(f"   âœ… åº“å­˜å……è¶³: {inventory[product_id]['quantity']} ä»¶")
    else:
        print(f"   âŒ åº“å­˜ä¸è¶³: {inventory[product_id]['quantity']} ä»¶")
        return
    
    # æ¨¡æ‹Ÿ2PCè¿‡ç¨‹
    print(f"\n   å¼€å§‹2PCäº‹åŠ¡...")
    time.sleep(1)
    
    print(f"   é˜¶æ®µ1: å‡†å¤‡æ›´æ–°åº“å­˜å’Œåˆ›å»ºè®¢å•...")
    time.sleep(1)
    print(f"   é˜¶æ®µ1: æ‰€æœ‰å‚ä¸è€…å‡†å¤‡å®Œæˆ")
    
    print(f"   é˜¶æ®µ2: æ‰§è¡Œåº“å­˜æ›´æ–°å’Œè®¢å•åˆ›å»º...")
    inventory[product_id]["quantity"] -= order_quantity
    total_amount = inventory[product_id]["price"] * order_quantity
    time.sleep(1)
    print(f"   é˜¶æ®µ2: æ“ä½œå®Œæˆ")
    
    print(f"\nğŸ“¦ è®¢å•å¤„ç†ååº“å­˜çŠ¶æ€:")
    for prod_id, info in inventory.items():
        print(f"   äº§å“ {prod_id} ({info['name']}): {info['quantity']} ä»¶, Â¥{info['price']}")
    
    print(f"\nğŸ“‹ è®¢å•è¯¦æƒ…:")
    print(f"   è®¢å•ID: ORD_{int(time.time())}")
    print(f"   äº§å“: {inventory[product_id]['name']}")
    print(f"   æ•°é‡: {order_quantity}")
    print(f"   æ€»é‡‘é¢: Â¥{total_amount:.2f}")
    print(f"   å®¢æˆ·ID: {customer_id}")
    
    print(f"\nâœ… è®¢å•å¤„ç†æˆåŠŸå®Œæˆï¼")

def simulate_failure_scenario():
    """æ¨¡æ‹Ÿæ•…éšœå¤„ç†åœºæ™¯"""
    print_section("æ•…éšœå¤„ç†åœºæ™¯æ¼”ç¤º")
    
    scenarios = [
        "ç½‘ç»œè¿æ¥è¶…æ—¶",
        "å‚ä¸è€…èŠ‚ç‚¹æ•…éšœ",
        "äº‹åŠ¡æ‰§è¡Œè¶…æ—¶",
        "æ•°æ®å†²çªæ£€æµ‹"
    ]
    
    scenario = random.choice(scenarios)
    transaction_id = f"tx_{int(time.time())}"
    
    print(f"ğŸš¨ æ¨¡æ‹Ÿæ•…éšœåœºæ™¯: {scenario}")
    print(f"ğŸ“‹ äº‹åŠ¡ID: {transaction_id}")
    
    print(f"\nğŸ”„ å¼€å§‹åˆ†å¸ƒå¼äº‹åŠ¡...")
    time.sleep(1)
    
    print(f"   é˜¶æ®µ1: å‘é€å‡†å¤‡è¯·æ±‚...")
    time.sleep(1)
    
    if scenario == "ç½‘ç»œè¿æ¥è¶…æ—¶":
        print(f"   æ•°æ®åº“1: âœ… å‡†å¤‡å®Œæˆ")
        print(f"   æ•°æ®åº“2: â° è¿æ¥è¶…æ—¶...")
        time.sleep(2)
        print(f"   åè°ƒå™¨: âŒ æ£€æµ‹åˆ°ç½‘ç»œæ•…éšœï¼Œæ‰§è¡Œå›æ»š")
        
    elif scenario == "å‚ä¸è€…èŠ‚ç‚¹æ•…éšœ":
        print(f"   æ•°æ®åº“1: âœ… å‡†å¤‡å®Œæˆ")
        print(f"   æ•°æ®åº“2: ğŸ’¥ èŠ‚ç‚¹æ•…éšœ")
        print(f"   åè°ƒå™¨: âŒ æ£€æµ‹åˆ°èŠ‚ç‚¹æ•…éšœï¼Œæ‰§è¡Œå›æ»š")
        
    elif scenario == "äº‹åŠ¡æ‰§è¡Œè¶…æ—¶":
        print(f"   æ•°æ®åº“1: âœ… å‡†å¤‡å®Œæˆ")
        print(f"   æ•°æ®åº“2: â° æ‰§è¡Œè¶…æ—¶...")
        time.sleep(2)
        print(f"   åè°ƒå™¨: âŒ äº‹åŠ¡è¶…æ—¶ï¼Œæ‰§è¡Œå›æ»š")
        
    elif scenario == "æ•°æ®å†²çªæ£€æµ‹":
        print(f"   æ•°æ®åº“1: âœ… å‡†å¤‡å®Œæˆ")
        print(f"   æ•°æ®åº“2: âš ï¸ æ£€æµ‹åˆ°æ•°æ®å†²çª")
        print(f"   åè°ƒå™¨: âŒ æ•°æ®å†²çªï¼Œæ‰§è¡Œå›æ»š")
    
    print(f"\nğŸ”„ æ‰§è¡Œå›æ»šæ“ä½œ...")
    time.sleep(1)
    print(f"   æ•°æ®åº“1: å›æ»šå®Œæˆ")
    print(f"   æ•°æ®åº“2: å›æ»šå®Œæˆ")
    
    print(f"\nâœ… æ•…éšœå¤„ç†å®Œæˆï¼Œç³»ç»ŸçŠ¶æ€å·²æ¢å¤")
    print(f"ğŸ“Š äº‹åŠ¡ {transaction_id} å·²å›æ»š")

def show_system_architecture():
    """æ˜¾ç¤ºç³»ç»Ÿæ¶æ„"""
    print_section("ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ")
    
    architecture = """
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                      Webç®¡ç†ç•Œé¢                            â”‚
    â”‚                   (Flask + SocketIO)                       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                   äº‹åŠ¡åè°ƒå™¨                                â”‚
    â”‚              (Transaction Manager)                         â”‚
    â”‚                                                             â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
    â”‚  â”‚   å‡†å¤‡é˜¶æ®µ   â”‚  â”‚   æŠ•ç¥¨é˜¶æ®µ   â”‚  â”‚   æäº¤é˜¶æ®µ   â”‚        â”‚
    â”‚  â”‚  (Prepare)  â”‚  â”‚   (Vote)    â”‚  â”‚  (Commit)   â”‚        â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                â”‚                â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
    â”‚ æ•°æ®åº“1  â”‚      â”‚ æ•°æ®åº“2  â”‚      â”‚   ...   â”‚
    â”‚ MySQL   â”‚      â”‚ MySQL   â”‚      â”‚         â”‚
    â”‚ :3306   â”‚      â”‚ :3307   â”‚      â”‚         â”‚
    â”‚         â”‚      â”‚         â”‚      â”‚         â”‚
    â”‚ è´¦æˆ·è¡¨   â”‚      â”‚ äº¤æ˜“è¡¨   â”‚      â”‚         â”‚
    â”‚ åº“å­˜è¡¨   â”‚      â”‚ è®¢å•è¡¨   â”‚      â”‚         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    """
    
    print(architecture)
    
    print("\nğŸ”§ æ ¸å¿ƒç»„ä»¶è¯´æ˜:")
    print("   â€¢ äº‹åŠ¡åè°ƒå™¨: ç®¡ç†åˆ†å¸ƒå¼äº‹åŠ¡çš„ç”Ÿå‘½å‘¨æœŸ")
    print("   â€¢ æ•°æ®åº“ç®¡ç†å™¨: ç®¡ç†æ•°æ®åº“è¿æ¥å’Œæ“ä½œ")
    print("   â€¢ Webç•Œé¢: æä¾›å¯è§†åŒ–ç®¡ç†å’Œç›‘æ§")
    print("   â€¢ æ—¥å¿—ç³»ç»Ÿ: è®°å½•ç³»ç»Ÿè¿è¡ŒçŠ¶æ€å’Œäº‹åŠ¡æ—¥å¿—")

def show_performance_metrics():
    """æ˜¾ç¤ºæ€§èƒ½æŒ‡æ ‡"""
    print_section("ç³»ç»Ÿæ€§èƒ½æŒ‡æ ‡")
    
    # æ¨¡æ‹Ÿæ€§èƒ½æ•°æ®
    metrics = {
        "äº‹åŠ¡ååé‡": f"{random.randint(50, 200)} TPS",
        "å¹³å‡å“åº”æ—¶é—´": f"{random.randint(10, 100)} ms",
        "ç³»ç»Ÿå¯ç”¨æ€§": f"{random.uniform(99.5, 99.9):.2f}%",
        "æ•°æ®ä¸€è‡´æ€§": "100% (å¼ºä¸€è‡´æ€§)",
        "å¹¶å‘è¿æ¥æ•°": f"{random.randint(10, 50)}",
        "å†…å­˜ä½¿ç”¨ç‡": f"{random.randint(30, 70)}%",
        "CPUä½¿ç”¨ç‡": f"{random.randint(20, 60)}%"
    }
    
    print("ğŸ“Š å½“å‰ç³»ç»Ÿæ€§èƒ½:")
    for metric, value in metrics.items():
        print(f"   {metric}: {value}")
    
    print(f"\nğŸ¯ æ€§èƒ½ç‰¹ç‚¹:")
    print("   â€¢ æ”¯æŒé«˜å¹¶å‘äº‹åŠ¡å¤„ç†")
    print("   â€¢ æ¯«ç§’çº§äº‹åŠ¡å“åº”æ—¶é—´")
    print("   â€¢ 99.9%+ ç³»ç»Ÿå¯ç”¨æ€§ä¿è¯")
    print("   â€¢ å¼ºä¸€è‡´æ€§æ•°æ®ä¿è¯")

def main():
    """ä¸»æ¼”ç¤ºå‡½æ•°"""
    print_banner()
    
    try:
        # æ˜¾ç¤ºç³»ç»Ÿæ¶æ„
        show_system_architecture()
        
        # ç­‰å¾…ç”¨æˆ·ç¡®è®¤
        input("\næŒ‰å›è½¦é”®ç»§ç»­æ¼”ç¤º...")
        
        # 2PCåè®®æ¼”ç¤º
        simulate_2pc_protocol()
        
        # ç­‰å¾…ç”¨æˆ·ç¡®è®¤
        input("\næŒ‰å›è½¦é”®ç»§ç»­æ¼”ç¤º...")
        
        # é“¶è¡Œè½¬è´¦åœºæ™¯
        simulate_banking_scenario()
        
        # ç­‰å¾…ç”¨æˆ·ç¡®è®¤
        input("\næŒ‰å›è½¦é”®ç»§ç»­æ¼”ç¤º...")
        
        # åº“å­˜ç®¡ç†åœºæ™¯
        simulate_inventory_scenario()
        
        # ç­‰å¾…ç”¨æˆ·ç¡®è®¤
        input("\næŒ‰å›è½¦é”®ç»§ç»­æ¼”ç¤º...")
        
        # æ•…éšœå¤„ç†åœºæ™¯
        simulate_failure_scenario()
        
        # ç­‰å¾…ç”¨æˆ·ç¡®è®¤
        input("\næŒ‰å›è½¦é”®ç»§ç»­æ¼”ç¤º...")
        
        # æ€§èƒ½æŒ‡æ ‡
        show_performance_metrics()
        
        print_section("æ¼”ç¤ºå®Œæˆ")
        print("ğŸ‰ åˆ†å¸ƒå¼æ•°æ®åº“ç³»ç»Ÿæ¼”ç¤ºç»“æŸï¼")
        print("\nğŸ“ æ¼”ç¤ºæ€»ç»“:")
        print("   âœ… 2PCåè®®å·¥ä½œåŸç†")
        print("   âœ… é“¶è¡Œè½¬è´¦ä¸šåŠ¡åœºæ™¯")
        print("   âœ… åº“å­˜ç®¡ç†ä¸šåŠ¡åœºæ™¯")
        print("   âœ… æ•…éšœå¤„ç†å’Œæ¢å¤æœºåˆ¶")
        print("   âœ… ç³»ç»Ÿæ€§èƒ½æŒ‡æ ‡")
        
        print(f"\nğŸš€ è¦å¯åŠ¨å®Œæ•´ç³»ç»Ÿï¼Œè¯·è¿è¡Œ:")
        print(f"   python main.py setup    # åˆå§‹åŒ–ç³»ç»Ÿ")
        print(f"   python main.py web      # å¯åŠ¨Webç•Œé¢")
        
    except KeyboardInterrupt:
        print(f"\n\nğŸ‘‹ æ¼”ç¤ºå·²ä¸­æ–­ï¼Œæ„Ÿè°¢è§‚çœ‹ï¼")
    except Exception as e:
        print(f"\nâŒ æ¼”ç¤ºè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: {e}")

if __name__ == "__main__":
    main()
